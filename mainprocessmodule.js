// Generated by CoffeeScript 2.7.0
//#############################################################################
//region debug
var action, executionCycle, iteration, log, logState, maxCycles, olog, setState, state;

import {
  createLogFunctions
} from "thingy-debug";

({log, olog} = createLogFunctions("mainprocessmodule"));

import * as Stt from "./statemodule.js";


//#############################################################################
state = null;

iteration = 0;

action = null;

//#############################################################################
maxCycles = 2e308;


//#############################################################################
export var initialize = function(cfg) {
  log("initialize");
  if (cfg.maxCycles != null) {
    maxCycles = cfg.maxCycles;
  }
};

//#############################################################################
export var execute = async function(args) {
  var err;
  log("execute");
  state = (await Stt.readState(args.wd));
  try {
    while (true) {
      await executionCycle();
    }
  } catch (error) {
    err = error;
    console.log(err);
  }
};

//#############################################################################
executionCycle = function() {
  logState();
  if (iteration === maxCycles) {
    throw new Error("Exceeded maxCycles!");
  }
  //# TODO implement
  iteration++;
};

//#############################################################################
logState = function() {
  return log(`@${new Date()}:${iteration} ${state["latest-state"]} TaskId:${state["latest-taskId"]} action: ${action} `);
};

//#############################################################################
setState = async function(taskId, stateString) {
  log("setState");
  state["latest-taskId"] = taskId;
  state["latest-state"] = stateString;
  await Stt.writeState();
};
